# @file GetExposureData.R
#
# Copyright 2016 Observational Health Data Sciences and Informatics
#
# This file is part of CaseControl
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

#' Get exposure data for cases and controls from a database
#'
#' @param connectionDetails            An R object of type\cr\code{connectionDetails} created using the
#'                                     function \code{createConnectionDetails} in the
#'                                     \code{DatabaseConnector} package.
#' @param oracleTempSchema                A schema where temp tables can be created in Oracle.
#' @param caseControls                 A data frame as generated by the \code{\link{selectControls}} function.
#' @param exposureDatabaseSchema          The name of the database schema that is the location where
#'                                        the exposure data used to define the exposure cohorts is
#'                                        available. If exposureTable = DRUG_ERA,
#'                                        exposureDatabaseSchema is not used but assumed to be
#'                                        cdmSchema.  Requires read permissions to this database.
#' @param exposureTable                   The tablename that contains the exposure cohorts.  If
#'                                        exposureTable <> drug_era, then expectation is exposureTable
#'                                        has format of COHORT table: cohort_definition_id, subject_id,
#'                                        cohort_start_date, cohort_end_date.
#' @param exposureIds                     A list of identifiers to define the exposures of interest. If
#'                                        exposureTable = drug_era, exposureIds should be concept_id.
#'                                        If exposureTable <> drug_era, exposureIds is used to select
#'                                        the cohort_definition_id in the cohort-like table. If no
#'                                        exposureIds are provided, all drugs or cohorts in the
#'                                        exposureTable are included as exposures.
#' @param cdmDatabaseSchema            Needed when constructing covariates: the name of the database schema that contains the OMOP CDM
#'                                     instance.  Requires read permissions to this database. On SQL
#'                                     Server, this should specifiy both the database and the schema,
#'                                     so for example 'cdm_instance.dbo'.
#' @param covariateSettings            An object of type \code{covariateSettings} as created using the
#'                                     \code{createCovariateSettings} function in the
#'                                     \code{FeatureExtraction} package. If NULL then no covariate data is retrieved.
#'
#' @export
getDbExposureData <- function(caseControls,
                              connectionDetails,
                              oracleTempSchema = NULL,
                              exposureDatabaseSchema,
                              exposureTable = "drug_era",
                              exposureIds = c(),
                              cdmDatabaseSchema = exposureDatabaseSchema,
                              covariateSettings = NULL) {
  connection <- DatabaseConnector::connect(connectionDetails)
  writeLines("Uploading cases and controls to database temp table")
  start <- Sys.time()
  caseControls$rowId <- 1:nrow(caseControls)
  data <- caseControls[, c("rowId", "personId", "indexDate")]
  colnames(data)[colnames(data) == "personId"] <- "subjectId"
  colnames(data)[colnames(data) == "indexDate"] <- "cohortStartDate"
  colnames(data) <- SqlRender::camelCaseToSnakeCase(colnames(data))
  DatabaseConnector::insertTable(connection = connection,
                                 tableName = "#case_controls",
                                 data = data,
                                 dropTableIfExists = TRUE,
                                 createTable = TRUE,
                                 tempTable = TRUE,
                                 oracleTempSchema = oracleTempSchema)
  delta <- Sys.time() - start
  writeLines(paste("Uploading took", signif(delta, 3), attr(delta, "units")))

  writeLines("Loading exposure data from server")
  start <- Sys.time()
  renderedSql <- SqlRender::loadRenderTranslateSql("queryExposure.sql",
                                                   packageName = "CaseControl",
                                                   dbms = connectionDetails$dbms,
                                                   oracleTempSchema = oracleTempSchema,
                                                   exposure_database_schema = exposureDatabaseSchema,
                                                   exposure_table = exposureTable,
                                                   exposure_ids = exposureIds)
  exposure <- DatabaseConnector::querySql(connection, renderedSql)
  colnames(exposure) <- SqlRender::snakeCaseToCamelCase(colnames(exposure))
  delta <- Sys.time() - start
  writeLines(paste("Loading took", signif(delta, 3), attr(delta, "units")))

  if (!is.null(covariateSettings)) {
    covariates <- FeatureExtraction::getDbCovariateData(connection = connection,
                                                        oracleTempSchema = oracleTempSchema,
                                                        cdmDatabaseSchema = cdmDatabaseSchema,
                                                        cdmVersion = 5,
                                                        cohortTable = "#case_controls",
                                                        cohortTableIsTemp = TRUE,
                                                        rowIdField = "row_id",
                                                        covariateSettings = covariateSettings,
                                                        normalize = TRUE)
  }
  sql <- "TRUNCATE TABLE #case_controls; DROP TABLE #case_controls;"
  sql <- SqlRender::translateSql(sql, targetDialect = connectionDetails$dbms, oracleTempSchema = oracleTempSchema)$sql
  DatabaseConnector::executeSql(connection, sql, progressBar = FALSE, reportOverallTime = FALSE)
  RJDBC::dbDisconnect(connection)

  result <- list(caseControls = caseControls,
                 exposure = exposure,
                 metaData = attr(caseControls, "metaData"))
  attr(result$caseControls, "metaData") <- NULL
  if (!is.null(covariateSettings)) {
    result$covariates <- covariates$covariates
    result$covariateRef <- covariates$covariateRef
    result$metaData$hasCovariates <- TRUE
    result$metaData$covariateMetaData <- covariates$metaData
  } else {
    result$metaData$hasCovariates <- FALSE
  }
  class(result) <- "caseControlsExposure"
  return(result)
}

#' Save the caseControlsExposure data to folder
#'
#' @description
#' \code{saveCaseControlsExposure} saves an object of type caseControlsExposure to folder.
#'
#' @param caseControlsExposure   An object of type \code{caseControlsExposure} as generated using \code{\link{getDbExposureData}}.
#' @param folder     The name of the folder where the data will be written. The folder should not yet
#'                   exist.
#'
#' @details
#' The data will be written to a set of files in the specified folder.
#'
#' @export
saveCaseControlsExposure <- function(caseControlsExposure, folder) {
  if (missing(caseControlsExposure))
    stop("Must specify caseControlsExposure")
  if (missing(folder))
    stop("Must specify folder")
  if (class(caseControlsExposure) != "caseControlsExposure")
    stop("Data not of class caseControlsExposure")

  if (caseControlsExposure$metaData$hasCovariates) {
    covariates <- caseControlsExposure$covariates
    covariateRef <- caseControlsExposure$covariateRef
    ffbase::save.ffdf(covariates, covariateRef, dir = folder, clone = TRUE)
  } else {
    dir.create(folder)
  }
  saveRDS(caseControlsExposure$caseControls, file = file.path(folder, "caseControls.rds"))
  saveRDS(caseControlsExposure$exposure, file = file.path(folder, "exposure.rds"))
  saveRDS(caseControlsExposure$metaData, file = file.path(folder, "metaData.rds"))
  invisible(TRUE)
}

#' Load the caseControlsExposure data from a folder
#'
#' @description
#' \code{loadCaseControlsExposure} loads an object of type caseControlsExposure from a folder in the file system.
#'
#' @param folder     The name of the folder containing the data.
#' @param readOnly   If true, the data is opened read only.
#'
#' @details
#' The data will be written to a set of files in the folder specified by the user.
#'
#' @return
#' An object of class \code{caseControlsExposure}.
#'
#' @export
loadCaseControlsExposure <- function(folder, readOnly = TRUE) {
  if (!file.exists(folder))
    stop(paste("Cannot find folder", folder))
  if (!file.info(folder)$isdir)
    stop(paste("Not a folder:", folder))

  caseControls <- readRDS(file.path(folder, "caseControls.rds"))
  exposure <- readRDS(file.path(folder, "exposure.rds"))
  metaData <- readRDS(file.path(folder, "metaData.rds"))
  result <- list(caseControls = caseControls, exposure = exposure, metaData = metaData)
  if (result$metaData$hasCovariates) {
    temp <- setwd(folder)
    absolutePath <- setwd(temp)
    e <- new.env()
    ffbase::load.ffdf(absolutePath, e)
    result$covariates <- get("covariates", envir = e)
    result$covariateRef <- get("covariateRef", envir = e)
    open(result$covariates, readonly = readOnly)
    open(result$covariateRef, readonly = readOnly)
    rm(e)
  }
  class(result) <- "caseControlsExposure"
  return(result)
}
