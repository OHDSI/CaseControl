<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Single studies using the CaseControl package • CaseControl</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Single studies using the CaseControl package">
<meta property="og:description" content="CaseControl">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">CaseControl</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/MultipleAnalyses.html">Running multiple analyses at once using the CaseControl package</a>
    </li>
    <li>
      <a href="../articles/SingleStudies.html">Single studies using the CaseControl package</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://ohdsi.github.io/MethodsLibrary">Methods Library</a>
</li>
<li>
  <a href="https://github.com/OHDSI/CaseControl/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Single studies using the CaseControl package</h1>
                        <h4 class="author">Martijn J. Schuemie</h4>
            
            <h4 class="date">2020-04-14</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/OHDSI/CaseControl/blob/master/vignettes/SingleStudies.Rmd"><code>vignettes/SingleStudies.Rmd</code></a></small>
      <div class="hidden name"><code>SingleStudies.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p>This vignette describes how you can use the <code>CaseControl</code> package to perform a single case-control study. We will walk through all the steps needed to perform an exemplar study, and we have selected the well-studied topic of the effect of NSAIDs on gastrointestinal (GI) bleeding-related hospitalization. For simplicity, we focus on one NSAID: diclofenac.</p>
</div>
<div id="installation-instructions" class="section level1">
<h1 class="hasAnchor">
<a href="#installation-instructions" class="anchor"></a>Installation instructions</h1>
<p>Before installing the <code>CaseControl</code> package make sure you have Java available. Java can be downloaded from <a href="http://www.java.com">www.java.com</a>. For Windows users, RTools is also necessary. RTools can be downloaded from <a href="http://cran.r-project.org/bin/windows/Rtools/">CRAN</a>.</p>
<p>The <code>CaseControl</code> package is currently maintained in a <a href="https://github.com/OHDSI/CaseControl">Github repository</a>, and has dependencies on other packages in Github. All of these packages can be downloaded and installed from within R using the <code>drat</code> package:</p>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span>(<span class="st">"drat"</span>)
<span class="kw pkg">drat</span><span class="kw ns">::</span><span class="fu">addRepo</span>(<span class="st">"OHDSI"</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span>(<span class="st">"CaseControl"</span>)</pre></body></html></div>
<p>Once installed, you can type <code><a href="https://rdrr.io/pkg/CaseControl/man">library(CaseControl)</a></code> to load the package.</p>
</div>
<div id="overview" class="section level1">
<h1 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h1>
<p>In the <code>CaseControl</code> package a study requires at least five steps:</p>
<ol style="list-style-type: decimal">
<li>Loading data on the cases and potential controls from the database needed for matching.</li>
<li>Selecting controls per case.</li>
<li>Loading exposure information for cases and controls.</li>
<li>Determining exposure status for cases and controls based on a definition of the risk window.</li>
<li>Fitting the model using conditional logistic regression.</li>
</ol>
<p>In the following sections these steps will be demonstrated.</p>
</div>
<div id="configuring-the-connection-to-the-server" class="section level1">
<h1 class="hasAnchor">
<a href="#configuring-the-connection-to-the-server" class="anchor"></a>Configuring the connection to the server</h1>
<p>We need to tell R how to connect to the server where the data are. <code>CaseControl</code> uses the <code>DatabaseConnector</code> package, which provides the <code>createConnectionDetails</code> function. Type <code>?createConnectionDetails</code> for the specific settings required for the various database management systems (DBMS). For example, one might connect to a PostgreSQL database using this code:</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">connectionDetails</span> <span class="kw">&lt;-</span> <span class="fu">createConnectionDetails</span>(<span class="kw">dbms</span> <span class="kw">=</span> <span class="st">"postgresql"</span>,
                                             <span class="kw">server</span> <span class="kw">=</span> <span class="st">"localhost/ohdsi"</span>,
                                             <span class="kw">user</span> <span class="kw">=</span> <span class="st">"joe"</span>,
                                             <span class="kw">password</span> <span class="kw">=</span> <span class="st">"supersecret"</span>)

<span class="no">cdmDatabaseSchema</span> <span class="kw">&lt;-</span> <span class="st">"my_cdm_data"</span>
<span class="no">cohortDatabaseSchema</span> <span class="kw">&lt;-</span> <span class="st">"my_results"</span>
<span class="no">cohortTable</span> <span class="kw">&lt;-</span> <span class="st">"my_cohorts"</span>
<span class="no">cdmVersion</span> <span class="kw">&lt;-</span> <span class="st">"5"</span></pre></body></html></div>
<p>The last three lines define the <code>cdmDatabaseSchema</code> and <code>cohortDatabaseSchema</code> variables,as well as the CDM version. We’ll use these later to tell R where the data in CDM format live, where we have stored our cohorts of interest, and what version CDM is used. Note that for Microsoft SQL Server, databaseschemas need to specify both the database and the schema, so for example <code>cdmDatabaseSchema &lt;- "my_cdm_data.dbo"</code>.</p>
</div>
<div id="preparing-the-health-outcome-of-interest-and-nesting-cohort" class="section level1">
<h1 class="hasAnchor">
<a href="#preparing-the-health-outcome-of-interest-and-nesting-cohort" class="anchor"></a>Preparing the health outcome of interest and nesting cohort</h1>
<p>We need to define the exposures and outcomes for our study. Additionally, we can specify a cohort in which to nest the study. The CDM also already contains standard cohorts in the <code>drug_era</code> and <code>condition_era</code> table that could be used if those meet the requirement of the study, but often we require custom cohort definitions. One way to define cohorts is by writing SQL statements against the OMOP CDM that populate a table of events in which we are interested. The resulting table should have the same structure as the <code>cohort</code> table in the CDM, meaning it should have the fields <code>cohort_definition_id</code>, <code>cohort_start_date</code>, <code>cohort_end_date</code>,and <code>subject_id</code>.</p>
<p>For our example study, we will rely on <code>drug_era</code> to define exposures, and we have created a file called <em>vignette.sql</em> with the following contents to define the outcome and the nesting cohort:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode sql"><code class="sourceCode sql"><span id="cb3-1"><a href="#cb3-1"></a><span class="co">/***********************************</span></span>
<span id="cb3-2"><a href="#cb3-2"></a><span class="co">File vignette.sql </span></span>
<span id="cb3-3"><a href="#cb3-3"></a><span class="co">***********************************/</span></span>
<span id="cb3-4"><a href="#cb3-4"></a></span>
<span id="cb3-5"><a href="#cb3-5"></a><span class="cf">IF</span> OBJECT_ID(<span class="st">'@cohortDatabaseSchema.@cohortTable'</span>, <span class="st">'U'</span>) <span class="kw">IS</span> <span class="kw">NOT</span> <span class="kw">NULL</span></span>
<span id="cb3-6"><a href="#cb3-6"></a>  <span class="kw">DROP</span> <span class="kw">TABLE</span> @cohortDatabaseSchema.@cohortTable;</span>
<span id="cb3-7"><a href="#cb3-7"></a></span>
<span id="cb3-8"><a href="#cb3-8"></a><span class="kw">SELECT</span> <span class="dv">1</span> <span class="kw">AS</span> cohort_definition_id,</span>
<span id="cb3-9"><a href="#cb3-9"></a>    condition_start_date <span class="kw">AS</span> cohort_start_date,</span>
<span id="cb3-10"><a href="#cb3-10"></a>    condition_end_date <span class="kw">AS</span> cohort_end_date,</span>
<span id="cb3-11"><a href="#cb3-11"></a>    condition_occurrence.person_id <span class="kw">AS</span> subject_id</span>
<span id="cb3-12"><a href="#cb3-12"></a><span class="kw">INTO</span> @cohortDatabaseSchema.@cohortTable</span>
<span id="cb3-13"><a href="#cb3-13"></a><span class="kw">FROM</span> @cdmDatabaseSchema.condition_occurrence</span>
<span id="cb3-14"><a href="#cb3-14"></a><span class="kw">INNER</span> <span class="kw">JOIN</span> @cdmDatabaseSchema.visit_occurrence</span>
<span id="cb3-15"><a href="#cb3-15"></a>    <span class="kw">ON</span> condition_occurrence.visit_occurrence_id <span class="op">=</span> visit_occurrence.visit_occurrence_id</span>
<span id="cb3-16"><a href="#cb3-16"></a><span class="kw">WHERE</span> condition_concept_id <span class="kw">IN</span> (</span>
<span id="cb3-17"><a href="#cb3-17"></a>        <span class="kw">SELECT</span> descendant_concept_id</span>
<span id="cb3-18"><a href="#cb3-18"></a>        <span class="kw">FROM</span> @cdmDatabaseSchema.concept_ancestor</span>
<span id="cb3-19"><a href="#cb3-19"></a>        <span class="kw">WHERE</span> ancestor_concept_id <span class="op">=</span> <span class="dv">192671</span> <span class="co">-- GI - Gastrointestinal haemorrhage</span></span>
<span id="cb3-20"><a href="#cb3-20"></a>        )</span>
<span id="cb3-21"><a href="#cb3-21"></a>    <span class="kw">AND</span> visit_occurrence.visit_concept_id <span class="kw">IN</span> (<span class="dv">9201</span>, <span class="dv">9203</span>);</span>
<span id="cb3-22"><a href="#cb3-22"></a>    </span>
<span id="cb3-23"><a href="#cb3-23"></a><span class="kw">INSERT</span> <span class="kw">INTO</span> @cohortDatabaseSchema.@cohortTable </span>
<span id="cb3-24"><a href="#cb3-24"></a>(cohort_definition_id, cohort_start_date, cohort_end_date, subject_id)</span>
<span id="cb3-25"><a href="#cb3-25"></a><span class="kw">SELECT</span> <span class="dv">2</span> <span class="kw">AS</span> cohort_definition_id,</span>
<span id="cb3-26"><a href="#cb3-26"></a>    <span class="fu">MIN</span>(condition_start_date) <span class="kw">AS</span> cohort_start_date,</span>
<span id="cb3-27"><a href="#cb3-27"></a>    <span class="kw">NULL</span> <span class="kw">AS</span> cohort_end_date,</span>
<span id="cb3-28"><a href="#cb3-28"></a>    person_id <span class="kw">AS</span> subject_id</span>
<span id="cb3-29"><a href="#cb3-29"></a><span class="kw">FROM</span> @cdmDatabaseSchema.condition_occurrence</span>
<span id="cb3-30"><a href="#cb3-30"></a><span class="kw">WHERE</span> condition_concept_id <span class="kw">IN</span> (</span>
<span id="cb3-31"><a href="#cb3-31"></a>        <span class="kw">SELECT</span> descendant_concept_id</span>
<span id="cb3-32"><a href="#cb3-32"></a>        <span class="kw">FROM</span> @cdmDatabaseSchema.concept_ancestor</span>
<span id="cb3-33"><a href="#cb3-33"></a>        <span class="kw">WHERE</span> ancestor_concept_id <span class="op">=</span> <span class="dv">80809</span> <span class="co">-- rheumatoid arthritis</span></span>
<span id="cb3-34"><a href="#cb3-34"></a>        )</span>
<span id="cb3-35"><a href="#cb3-35"></a><span class="kw">GROUP</span> <span class="kw">BY</span> person_id;</span></code></pre></div>
<p>This is parameterized SQL which can be used by the <code>SqlRender</code> package. We use parameterized SQL so we do not have to pre-specify the names of the CDM and cohort schemas. That way, if we want to run the SQL on a different schema, we only need to change the parameter values; we do not have to change the SQL code. By also making use of translation functionality in <code>SqlRender</code>, we can make sure the SQL code can be run in many different environments.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r">library(SqlRender)
sql &lt;- readSql("vignette.sql")
sql &lt;- render(sql,
              cdmDatabaseSchema = cdmDatabaseSchema, 
              cohortDatabaseSchema = cohortDatabaseSchema
              cohortTable = cohortTable)
sql &lt;- translate(sql, targetDialect = connectionDetails$dbms)

connection &lt;- connect(connectionDetails)
executeSql(connection, sql)</pre></body></html></div>
<p>In this code, we first read the SQL from the file into memory. In the next line, we replace the three parameter names with the actual values. We then translate the SQL into the dialect appropriate for the DBMS we already specified in the <code>connectionDetails</code>. Next, we connect to the server, and submit the rendered and translated SQL.</p>
<p>If all went well, we now have a table with the outcome of interest and the nesting cohort. We can see how many events:</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">sql</span> <span class="kw">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span>(<span class="st">"SELECT cohort_definition_id, COUNT(*) AS count"</span>,
             <span class="st">"FROM @cohortDatabaseSchema.@cohortTable"</span>,
             <span class="st">"GROUP BY cohort_definition_id"</span>)
<span class="no">sql</span> <span class="kw">&lt;-</span> <span class="fu">render</span>(<span class="no">sql</span>,
              <span class="kw">cohortDatabaseSchema</span> <span class="kw">=</span> <span class="no">cohortDatabaseSchema</span>,
              <span class="kw">cohortTable</span> <span class="kw">=</span> <span class="no">cohortTable</span>)
<span class="no">sql</span> <span class="kw">&lt;-</span> <span class="fu">translate</span>(<span class="no">sql</span>, <span class="kw">targetDialect</span> <span class="kw">=</span> <span class="no">connectionDetails</span>$<span class="no">dbms</span>)

<span class="fu">querySql</span>(<span class="no">connection</span>, <span class="no">sql</span>)</pre></body></html></div>
<pre><code>#&gt;   cohort_definition_id  count
#&gt; 1                    1 422274
#&gt; 2                    2 118430</code></pre>
</div>
<div id="extracting-the-data-from-the-server" class="section level1">
<h1 class="hasAnchor">
<a href="#extracting-the-data-from-the-server" class="anchor"></a>Extracting the data from the server</h1>
<p>Now we can tell <code>CaseControl</code> to extract the necessary data on cases and potential controls:</p>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="no">caseData</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/getDbCaseData.html">getDbCaseData</a></span>(<span class="kw">connectionDetails</span> <span class="kw">=</span> <span class="no">connectionDetails</span>,
                          <span class="kw">cdmDatabaseSchema</span> <span class="kw">=</span> <span class="no">cdmDatabaseSchema</span>,
                          <span class="kw">oracleTempSchema</span> <span class="kw">=</span> <span class="no">oracleTempSchema</span>,
                          <span class="kw">outcomeDatabaseSchema</span> <span class="kw">=</span> <span class="no">cohortDatabaseSchema</span>,
                          <span class="kw">cohortTable</span> <span class="kw">=</span> <span class="no">cohortTable</span>,
                          <span class="kw">outcomeIds</span> <span class="kw">=</span> <span class="fl">1</span>,
                          <span class="kw">useNestingCohort</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                          <span class="kw">nestingCohortDatabaseSchema</span> <span class="kw">=</span> <span class="no">cohortDatabaseSchema</span>,
                          <span class="kw">nestingCohortTable</span> <span class="kw">=</span> <span class="no">cohortTable</span>,
                          <span class="kw">nestingCohortId</span> <span class="kw">=</span> <span class="fl">2</span>,
                          <span class="kw">useObservationEndAsNestingEndDate</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                          <span class="kw">getVisits</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
<span class="no">caseData</span></pre></body></html></div>
<pre><code>#&gt; Case data object
#&gt; 
#&gt; Outcome concept ID(s): 1
#&gt; Nesting cohort ID: 2</code></pre>
<p>There are many parameters, but they are all documented in the <code>CaseControl</code> manual. In short, we are pointing the function to the table created earlier and indicating which concept ID in that table identifies the outcome. Note that it is possible to fetch the data for multiple outcomes at once for efficiency. We furthermore specify a nesting cohort in the same table, meaning that people will be eligible to be cases or controls if and when they fall inside the specified cohort. In this case, the nesting cohort starts when people have their first diagnosis of rheumatoid arthritis. We use the <code>useObservationEndAsNestingEndDate</code> argument to indicate people will stay eligible until the end of their observation period. We furthermore specify we want to retrieve data on patient visits, which will be used later on for matching.</p>
<p>Data about the cases and potential controls are extracted from the server and stored in the <code>caseData</code> object. This object uses the package <code>ff</code> to store information in a way that ensures R does not run out of memory, even when the data are large.</p>
<p>We can use the generic <code><a href="https://rdrr.io/r/base/summary.html">summary()</a></code> function to view some more information of the data we extracted:</p>
<div class="sourceCode" id="cb9"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">caseData</span>)</pre></body></html></div>
<pre><code>#&gt; caseData object summary
#&gt; 
#&gt; Outcome concept ID(s): 1
#&gt; Nesting cohort ID: 2
#&gt; 
#&gt; Population count: 168742
#&gt; Population window count: 168742
#&gt; 
#&gt; Outcome counts:
#&gt;   Event count Case count
#&gt; 1       20306      12819</code></pre>
<div id="saving-the-data-to-file" class="section level2">
<h2 class="hasAnchor">
<a href="#saving-the-data-to-file" class="anchor"></a>Saving the data to file</h2>
<p>Creating the <code>caseData</code> object can take considerable computing time, and it is probably a good idea to save it for future sessions. Because <code>caseData</code> uses <code>ff</code>, we cannot use R’s regular save function. Instead, we’ll have to use the <code><a href="../reference/saveCaseData.html">saveCaseData()</a></code> function:</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="fu"><a href="../reference/saveCaseData.html">saveCaseData</a></span>(<span class="no">caseData</span>, <span class="st">"GiBleed"</span>)</pre></body></html></div>
<p>We can use the <code><a href="../reference/loadCaseData.html">loadCaseData()</a></code> function to load the data in a future session.</p>
</div>
</div>
<div id="selecting-controls" class="section level1">
<h1 class="hasAnchor">
<a href="#selecting-controls" class="anchor"></a>Selecting controls</h1>
<p>Next, we can use the data to select controls. In this example we’ll selected matched controls, meaning that for every case we’ll find individually matched controls:</p>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">matchingCriteria</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/createMatchingCriteria.html">createMatchingCriteria</a></span>(<span class="kw">controlsPerCase</span> <span class="kw">=</span> <span class="fl">2</span>,
                                           <span class="kw">matchOnAge</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                                           <span class="kw">ageCaliper</span> <span class="kw">=</span> <span class="fl">2</span>,
                                           <span class="kw">matchOnGender</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                                           <span class="kw">matchOnProvider</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
                                           <span class="kw">matchOnVisitDate</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                                           <span class="kw">visitDateCaliper</span> <span class="kw">=</span> <span class="fl">30</span>)

<span class="no">caseControls</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/selectControls.html">selectControls</a></span>(<span class="kw">caseData</span> <span class="kw">=</span> <span class="no">caseData</span>,
                               <span class="kw">outcomeId</span> <span class="kw">=</span> <span class="fl">1</span>,
                               <span class="kw">firstOutcomeOnly</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                               <span class="kw">washoutPeriod</span> <span class="kw">=</span> <span class="fl">180</span>,
                               <span class="kw">controlSelectionCriteria</span> <span class="kw">=</span> <span class="no">matchingCriteria</span>)</pre></body></html></div>
<p>In this example, we specify a washout period of 180 days, meaning that both cases and controls are required to have a minimum of 180 days of observation prior to the index date. We also specify we will only consider the first outcome per person. If a person’s first outcome is within the washout period, that person will be removed from the analysis. We match on calendar time (implicit), age, gender, and visit date, and randomly sample up to two controls per case. Matching on visit date implies that the control should have a visit within n days from the index date of the case (n = 30 in this example), and the index date for the control will be set to the visit date. The purpose of this is to make the index dates more similar between cases and control, because almost by definition we would expect the case to have a visit on the index date. Finally, we ask that cases for which no matching control was found be removed from the analysis.</p>
<p>The <code>caseControls</code> object is a data frame with four columns:</p>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">caseControls</span>)</pre></body></html></div>
<pre><code>#&gt;   personId  indexDate isCase stratumId
#&gt; 1        3 2009-10-10   TRUE         1
#&gt; 2      123 2009-10-11  FALSE         1
#&gt; 3      345 2009-10-09  FALSE         1
#&gt; 4        6 2010-05-04   TRUE         2
#&gt; 5      234 2010-05-04  FALSE         2
#&gt; 6      567 2010-05-05  FALSE         2</code></pre>
<p>We can show the attrition to see why cases and events were filtered:</p>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="fu"><a href="../reference/getAttritionTable.html">getAttritionTable</a></span>(<span class="no">caseControls</span>)</pre></body></html></div>
<pre><code>#&gt;                      description eventCount caseCount
#&gt; 1                Original counts      20306     12819
#&gt; 2               First event only      12819     12819
#&gt; 3 Require 180 days of prior obs.       7569      7569
#&gt; 4      Remove unmatched controls       7569      7569</code></pre>
<p>An alternative to selecting individually matched controls is to create a sample controls, controls that are not individually linked to cases. This can be done using the <code>createSamplingCriteria</code> instead of the <code>createMatchingCriteria</code> function. For example:</p>
<div class="sourceCode" id="cb17"><html><body><pre class="r"><span class="no">samplingCriteria</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/createSamplingCriteria.html">createSamplingCriteria</a></span>(<span class="kw">controlsPerCase</span> <span class="kw">=</span> <span class="fl">1</span>)

<span class="no">caseControls2</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/selectControls.html">selectControls</a></span>(<span class="kw">caseData</span> <span class="kw">=</span> <span class="no">caseData</span>,
                                <span class="kw">outcomeId</span> <span class="kw">=</span> <span class="fl">1</span>,
                                <span class="kw">firstOutcomeOnly</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                                <span class="kw">washoutPeriod</span> <span class="kw">=</span> <span class="fl">180</span>,
                                <span class="kw">controlSelectionCriteria</span> <span class="kw">=</span> <span class="no">samplingCriteria</span>)</pre></body></html></div>
</div>
<div id="loading-exposure-data-and-covariates" class="section level1">
<h1 class="hasAnchor">
<a href="#loading-exposure-data-and-covariates" class="anchor"></a>Loading exposure data and covariates</h1>
<p>Next, we load information on the exposures of the cases and controls, as well as covariates.</p>
<div class="sourceCode" id="cb18"><html><body><pre class="r"><span class="no">covarSettings</span> <span class="kw">&lt;-</span> <span class="fu">createCovariateSettings</span>(<span class="kw">useCharlsonIndex</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                                         <span class="kw">useChads2</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                                         <span class="kw">useDcsi</span> <span class="kw">=</span> <span class="fl">TRUE</span>)

<span class="no">caseControlsExposure</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/getDbExposureData.html">getDbExposureData</a></span>(<span class="kw">connectionDetails</span> <span class="kw">=</span> <span class="no">connectionDetails</span>,
                                          <span class="kw">caseControls</span> <span class="kw">=</span> <span class="no">caseControls</span>,
                                          <span class="kw">oracleTempSchema</span> <span class="kw">=</span> <span class="no">oracleTempSchema</span>,
                                          <span class="kw">exposureDatabaseSchema</span> <span class="kw">=</span> <span class="no">cdmDatabaseSchema</span>,
                                          <span class="kw">exposureTable</span> <span class="kw">=</span> <span class="st">"drug_era"</span>,
                                          <span class="kw">exposureIds</span> <span class="kw">=</span> <span class="fl">1124300</span>,
                                          <span class="kw">covariateSettings</span> <span class="kw">=</span> <span class="no">covarSettings</span>)</pre></body></html></div>
<p>Here we specify that we will use the <code>drug_era</code> table to identify exposures, and will only retrieve data on exposure to Diclofenac (concept ID 1124300). We use the <code>covariateSettings</code> function of the FeatureExtraction package to specify which covariates to construct. In this example the only coviariates are the Charlson comorbidity index, Diabetes Complications Severity Index (DCSI), and CHADS2 score.</p>
<p>When including covariates, the <code>caseControlsExposure</code> object uses <code>ff</code> to store large objects and therefore cannot be stored using standard functions. Please use <code>saveCaseControlsExposure</code> to save:</p>
<div class="sourceCode" id="cb19"><html><body><pre class="r"><span class="fu"><a href="../reference/saveCaseControlsExposure.html">saveCaseControlsExposure</a></span>(<span class="no">caseControlsExposure</span>, <span class="st">"caseControlsExposure"</span>)</pre></body></html></div>
</div>
<div id="creating-case-control-data" class="section level1">
<h1 class="hasAnchor">
<a href="#creating-case-control-data" class="anchor"></a>Creating case-control data</h1>
<p>We can now use the exposure data to determine exposure status for the cases and controls. (The reason why fetching exposure data and determining exposure status is split up is that this is more efficient when we want to evaluate several risk window definitions.)</p>
<div class="sourceCode" id="cb20"><html><body><pre class="r"><span class="no">caseControlData</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/createCaseControlData.html">createCaseControlData</a></span>(<span class="kw">caseControlsExposure</span> <span class="kw">=</span> <span class="no">caseControlsExposure</span>,
                                         <span class="kw">exposureId</span> <span class="kw">=</span> <span class="fl">1124300</span>,
                                         <span class="kw">firstExposureOnly</span> <span class="kw">=</span> <span class="fl">FALSE</span>,
                                         <span class="kw">riskWindowStart</span> <span class="kw">=</span> <span class="fl">0</span>,
                                         <span class="kw">riskWindowEnd</span> <span class="kw">=</span> <span class="fl">0</span>)</pre></body></html></div>
<p>Here we specify we are interested in all exposures, not just the first one, and that the exposure should overlap with the index date (the risk window starts and ends on day 0, the index date). The <code>caseControlData</code> object is a data frame with five columns:</p>
<div class="sourceCode" id="cb21"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span>(<span class="no">caseControlData</span>)</pre></body></html></div>
<pre><code>#&gt;   personId  indexDate isCase stratumId rowId exposed
#&gt; 1        3 2009-10-10   TRUE         1     1       1
#&gt; 2      123 2009-10-11  FALSE         1     2       0
#&gt; 3      345 2009-10-09  FALSE         1     3       0
#&gt; 4        6 2010-05-04   TRUE         2     4       0
#&gt; 5      234 2010-05-04  FALSE         2     5       0
#&gt; 6      567 2010-05-05  FALSE         2     6       0</code></pre>
</div>
<div id="fitting-the-model" class="section level1">
<h1 class="hasAnchor">
<a href="#fitting-the-model" class="anchor"></a>Fitting the model</h1>
<p>We can now fit the model. In case we used matching to select controls this will be a logistic regression conditioned on the matched sets. Else it will be an unconditioned logistic regression.</p>
<div class="sourceCode" id="cb23"><html><body><pre class="r"><span class="no">fit</span> <span class="kw">&lt;-</span> <span class="fu"><a href="../reference/fitCaseControlModel.html">fitCaseControlModel</a></span>(<span class="no">caseControlData</span>,
                           <span class="kw">useCovariates</span> <span class="kw">=</span> <span class="fl">TRUE</span>,
                           <span class="kw">caseControlsExposure</span> <span class="kw">=</span> <span class="no">caseControlsExposure</span>,
                           <span class="kw">prior</span> <span class="kw">=</span> <span class="fu">createPrior</span>(<span class="st">"none"</span>))

<span class="no">fit</span></pre></body></html></div>
<pre><code>#&gt; Case-Control fitted model
#&gt; Status: OK
#&gt; 
#&gt;           Estimate lower .95 upper .95   logRr seLogRr
#&gt; treatment  1.05357   0.82739   1.33405 0.05218  0.1219</code></pre>
<p>The generic functions <code>summary</code>, <code>coef</code>, and <code>confint</code> are implemented for the <code>fit</code> object:</p>
<div class="sourceCode" id="cb25"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">fit</span>)</pre></body></html></div>
<pre><code>#&gt; Case-Control fitted model
#&gt; Status: OK
#&gt; 
#&gt;           Estimate lower .95 upper .95   logRr seLogRr
#&gt; treatment  1.05357   0.82739   1.33405 0.05218  0.1219
#&gt; 
#&gt; Counts
#&gt;       Cases Controls Exposed cases Exposed controls
#&gt; Count  7569    15138           110              225</code></pre>
<div class="sourceCode" id="cb27"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span>(<span class="no">fit</span>)</pre></body></html></div>
<pre><code>#&gt; [1] 0.05217973</code></pre>
<div class="sourceCode" id="cb29"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/stats/confint.html">confint</a></span>(<span class="no">fit</span>)</pre></body></html></div>
<pre><code>#&gt; [1] -0.1894850  0.2882181</code></pre>
</div>
<div id="acknowledgments" class="section level1">
<h1 class="hasAnchor">
<a href="#acknowledgments" class="anchor"></a>Acknowledgments</h1>
<p>Considerable work has been dedicated to provide the <code>CaseControl</code> package.</p>
<div class="sourceCode" id="cb31"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/citation.html">citation</a></span>(<span class="st">"CaseControl"</span>)</pre></body></html></div>
<pre><code>#&gt; 
#&gt; To cite package 'CaseControl' in publications use:
#&gt; 
#&gt;   Martijn Schuemie (2019). CaseControl: Case-Control. R package version
#&gt;   2.0.0. https://github.com/OHDSI/CaseControl
#&gt; 
#&gt; A BibTeX entry for LaTeX users is
#&gt; 
#&gt;   @Manual{,
#&gt;     title = {CaseControl: Case-Control},
#&gt;     author = {Martijn Schuemie},
#&gt;     year = {2019},
#&gt;     note = {R package version 2.0.0},
#&gt;     url = {https://github.com/OHDSI/CaseControl},
#&gt;   }</code></pre>
<p>Furthermore, <code>CaseControl</code> makes extensive use of the <code>Cyclops</code> package.</p>
<div class="sourceCode" id="cb33"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/citation.html">citation</a></span>(<span class="st">"Cyclops"</span>)</pre></body></html></div>
<pre><code>#&gt; 
#&gt; To cite Cyclops in publications use:
#&gt; 
#&gt; Suchard MA, Simpson SE, Zorych I, Ryan P, Madigan D (2013). "Massive
#&gt; parallelization of serial inference algorithms for complex generalized
#&gt; linear models." _ACM Transactions on Modeling and Computer Simulation_,
#&gt; *23*, 10. &lt;URL: http://dl.acm.org/citation.cfm?id=2414791&gt;.
#&gt; 
#&gt; A BibTeX entry for LaTeX users is
#&gt; 
#&gt;   @Article{,
#&gt;     author = {M. A. Suchard and S. E. Simpson and I. Zorych and P. Ryan and D. Madigan},
#&gt;     title = {Massive parallelization of serial inference algorithms for complex generalized linear models},
#&gt;     journal = {ACM Transactions on Modeling and Computer Simulation},
#&gt;     volume = {23},
#&gt;     pages = {10},
#&gt;     year = {2013},
#&gt;     url = {http://dl.acm.org/citation.cfm?id=2414791},
#&gt;   }</code></pre>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Martijn Schuemie.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.0.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
